name: "VHS Tape"

on:
  workflow_dispatch:
  release:
    types: [published]

env:
  tape: scripts/demo.tape
  image: assets/demo.gif
  branch: images

jobs:
  vhs:
    name: "VHS"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: write

    steps:
      - name: "Checkout"
        uses: actions/checkout@v6

      - name: "Release Wait"
        if: ${{ github.event_name == 'release' }}
        run: |
          echo "Sleeping 5 minutes for release asset generation..."
          sleep 300

      - name: "Install Release"
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: yhoundz/parm

      - name: "Debug Release"
        run: |
          parm --version

      - name: "Install VHS"
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: charmbracelet/vhs
          binaries-location: vhs_0.10.0_Linux_x86_64

      - name: "Install Dependencies"
        id: install
        run: |
          echo "::group::install"
          sudo apt update
          sudo apt install -y ffmpeg ttyd
          echo "::endgroup::"

          ffmpeg -version
          ttyd --version
          vhs --version

          dir="$(dirname "${{ env.image }}")"
          echo "dir: $dir"
          mkdir -p "$dir"
          echo "dir=$dir" >> "$GITHUB_OUTPUT"

      - name: "Create VHS"
        run: |
          export PATH="${PATH}:${HOME}/.local/share/parm/bin"
          vhs "${{ env.tape }}"

      - name: "Debug VHS"
        continue-on-error: true
        run: |
          ls "${{ steps.install.outputs.dir }}"
          file "${{ env.image }}"

      - name: "Upload Artifact"
        uses: actions/upload-artifact@v6
        with:
          name: image
          path: ${{ env.image }}

      - name: "Push Image"
        run: |
          git lfs install
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          mkdir -p "${{ runner.temp }}/${{ steps.install.outputs.dir }}"
          mv "${{ env.image }}" "${{ runner.temp }}/${{ env.image }}"

          git fetch origin "${{ env.branch }}"
          git checkout "${{ env.branch }}"

          mkdir -p "${{ steps.install.outputs.dir }}"
          mv -f "${{ runner.temp }}/${{ env.image }}" "${{ env.image }}" 

          git lfs track "${{ env.image }}"
          git add .gitattributes "${{ env.image }}"
          git commit -m "Update ${{ env.image }}"
          git push -f origin "${{ env.branch }}"

      - name: "Set URL"
        id: url
        run: |
          url="https://media.githubusercontent.com/media/${{ github.repository }}/refs/heads/${{ env.branch }}/${{ env.image }}"
          echo "url: $url"
          echo "url=$url" >> "$GITHUB_OUTPUT"

      - name: "Job Summary"
        continue-on-error: true
        run: |
          md="## VHS ðŸ“¼\n\n"
          md+="<${{ steps.url.outputs.url }}>\n\n"
          md+="\`\`\`text\n${{ steps.url.outputs.url }}\n\`\`\`\n\n"
          md+="[![URL](${{ steps.url.outputs.url }})](${{ steps.url.outputs.url }})\n\n"
          echo -e "${md}" >> "$GITHUB_STEP_SUMMARY"
